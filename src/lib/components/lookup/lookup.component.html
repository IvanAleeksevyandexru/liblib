<div class="lookup" [ngClass]="contextClass ? [contextClass] : []" (click)="returnFocus($event)" libClickOutside
     (clickOutside)="handleBlur(true);">
  <div class="lookup-field" #lookupField [ngClass]="{expanded: expanded, invalid: invalidDisplayed, 'with-expand-button': showExpandCollapse}">
    <lib-search-bar #searchBar
      contextClass="lookup-input"
      [tabIndex]="tabIndex"
      [maxlength]="maxlength"
      [disabled]="disabled"
      [invalid]="invalid"
      [placeholder]="htmlPlaceholder ? null : placeholder"
      [clearable]="clearable"
      [validationShowOn]="validationShowOn"
      [showMagnifyingGlass]="showMagnifyingGlass"
      [queryTimeout]="queryTimeout"
      [queryMinSymbolsCount]="queryMinSymbolsCount"
      [parallelSearch]="false"
      [searchOnProgrammaticChange]="false"
      [searchOnlyIfFocused]="true"
      [searchOnFocus]="searchOnFocus"
      [searchByForcing]="false"
      [searchByTextInput]="true"
      [showStaticContent]="item || htmlPlaceholder"
      [forceShowStaticContent]="forceShowStatic"
      [suggestion]="showSuggestion ? suggestion : null"
      [(ngModel)]="query"
      (newSearch)="lookupItems($event)"
      [searching]="searching"
      (focus)="handleFocus()"
      (blur)="handleBlur(false)"
      (click)="lookupItemsOrClose()"
      (input)="showTextField()"
      (keydown)="handleKeydownNavigation($event)"
      (cleared)="clearInput()"
      (suggestionSelected)="selectSuggestion($event)">
        <div class="lookup-item" *ngIf="item">
          <ng-container *ngIf="formatter">
            <div *ngIf="escapeHtml" class="item-container">{{item.formatted}}</div>
            <div *ngIf="!escapeHtml" class="item-container" [innerHTML]="item.formatted | safeHtml"></div>
          </ng-container>
          <ng-container *ngIf="!formatter">
            <div *ngIf="escapeHtml" class="item-container">
              <span class="lookup-item-text">{{item.text}}</span>
            </div>
            <div *ngIf="!escapeHtml" class="item-container">
              <span class="lookup-item-text" [innerHTML]="item.text | safeHtml"></span>
            </div>
          </ng-container>
        </div>
        <ng-container *ngIf="!item && htmlPlaceholder">
          <div [innerHTML]="htmlPlaceholder | safeHtml"></div>
        </ng-container>
    </lib-search-bar>
    <div class="expand-collapse" *ngIf="showExpandCollapse" [ngClass]="{expanded: expanded}" (click)="lookupItemsOrClose(true)"></div>
  </div>
  <div class="lookup-list-wrapper">
    <div class="lookup-list-container" #lookupList [ngClass]="{hidden: !expanded}" libStopScreenScroll>
      <perfect-scrollbar #scrollComponent [config]="{suppressScrollX: true, wheelPropagation: false}" *ngIf="items.length">
        <div class="lookup-list-area" #scrollableArea>
          <div *ngFor="let item of items" class="lookup-item" [attr.itemId]="item.id"
               (click)="selectItem(item)" (mouseenter)="highlight(item)" (mouseleave)="highlight(null)"
               [ngClass]="{highlighted: item === highlighted}">
            <ng-container *ngIf="listFormatter">
              <div *ngIf="escapeHtml" class="item-container">{{item.text | dynamicFormatter: listFormatter: item}}</div>
              <div *ngIf="!escapeHtml" class="item-container" [innerHTML]="item.text | dynamicFormatter: listFormatter: item | safeHtml"></div>
            </ng-container>
            <ng-container *ngIf="formatter">
              <div *ngIf="escapeHtml" class="item-container">{{item.formatted}}</div>
              <div *ngIf="!escapeHtml" class="item-container" [innerHTML]="item.formatted | safeHtml"></div>
            </ng-container>
            <ng-container *ngIf="!formatter && !listFormatter">
              <ng-container *ngIf="highlightSubstring">
                <div *ngIf="escapeHtml" class="item-container">
                  <span class="lookup-item-text">{{item.pre}}</span>
                  <span class="lookup-item-text highlight-part">{{item.highlighted}}</span>
                  <span class="lookup-item-text">{{item.post}}</span>
                </div>
                <div *ngIf="!escapeHtml" class="item-container">
                  <span class="lookup-item-text" [innerHTML]="item.pre | safeHtml"></span>
                  <span class="lookup-item-text highlight-part" [innerHTML]="item.highlighted | safeHtml"></span>
                  <span class="lookup-item-text" [innerHTML]="item.post | safeHtml"></span>
                </div>
              </ng-container>
              <ng-container *ngIf="!highlightSubstring">
                <div *ngIf="escapeHtml" class="item-container">
                  <span class="lookup-item-text">{{item.text}}</span>
                </div>
                <div *ngIf="!escapeHtml" class="item-container">
                  <span class="lookup-item-text" [innerHTML]="item.text | safeHtml"></span>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </div>
      </perfect-scrollbar>
      <div *ngIf="showNotFound && !items.length" class="lookup-list-area">
        <div class="lookup-item nothing-found" (click)="closeDropdown(); returnFocus(); ">
          <div class="item-container">
            <span class="lookup-item-text" [innerHTML]="'LOOKUP.NOTHING_FOUND' | libTranslate | subst:query"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

